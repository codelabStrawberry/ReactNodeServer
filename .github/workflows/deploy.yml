name: Deploy

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ğŸ” Docker Hub ë¡œê·¸ì¸
      - name: Docker Login
        run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      # ğŸ—ï¸ ì´ë¯¸ì§€ ë¹Œë“œ
      - name: Build Images
        run: |
          docker build -t vawing21/node:latest ./server
          docker build -t vawing21/nginx:latest ./client

      # ğŸ“¤ Docker Hub í‘¸ì‹œ
      - name: Push Images
        run: |
          docker push vawing21/node:latest
          docker push vawing21/nginx:latest

      # ğŸ”‘ SSH í‚¤ íŒŒì¼ ìƒì„± (CRLF ì œê±° í¬í•¨)
      - name: Prepare SSH key
        run: |
          echo "${{ secrets.AWS_SSH_KEY }}" > key.pem
          sed -i 's/\r$//' key.pem
          chmod 600 key.pem

      # ğŸš€ ì„œë²„ ë°°í¬ (ë„¤ì´í‹°ë¸Œ ssh ì‚¬ìš©)
      - name: SSH Deploy
        run: |
          ssh -o StrictHostKeyChecking=no \
              -i key.pem \
              ${{ secrets.AWS_SERVER_USER }}@${{ secrets.AWS_SERVER_HOST }} << 'EOF'
            whoami
            pwd
            docker pull vawing21/node:latest
            docker pull vawing21/nginx:latest
            docker compose down
            docker compose up -d --pull always
          EOF
