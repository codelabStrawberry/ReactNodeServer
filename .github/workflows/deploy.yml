name: Deploy

on:
  push:
    branches: [main]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. GitHub ë¦¬í¬ ì²´í¬ì•„ì›ƒ
      - name: Checkout
        uses: actions/checkout@v4

      # ğŸ” Docker Hub ë¡œê·¸ì¸ (Access Token ì „ì œ)
      - name: Docker Login
        run: |
          echo "${{ secrets.DOCKER_PASSWORD }}" | docker login \
          -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      # ğŸ—ï¸ ì´ë¯¸ì§€ ë¹Œë“œ + latest íƒœê·¸ ëª…ì‹œ
      - name: Build Images
        run: |
          docker build -t vawing21/node:latest ./server
          docker build -t vawing21/nginx:latest ./client

      # ğŸ“¤ Docker Hub í‘¸ì‹œ
      - name: Push Images
        run: |
          docker push vawing21/node:latest
          docker push vawing21/nginx:latest

      # 6. SSHë¡œ EC2 ì ‘ì† â†’ docker compose ë°°í¬
      - name: Deploy via SSH (compose up)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.AWS_SERVER_HOST }}
          username: ${{ secrets.AWS_SERVER_USER }}
          key: ${{ secrets.AWS_SSH_KEY }}
          port: 22
          script: |
            cd /home/ubuntu/ReactNodeServer   # â¬…ï¸ ì‹¤ì œ ê²½ë¡œë¡œ ìˆ˜ì •
            pwd
            ls -l
            docker pull vawing21/node:latest
            docker pull vawing21/nginx:latest
            docker compose down
            docker compose up -d --pull always
