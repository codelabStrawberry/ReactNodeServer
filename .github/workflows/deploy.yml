name: Deploy

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ğŸ” Docker Hub ë¡œê·¸ì¸ (ë°±ìŠ¬ë˜ì‹œ ë¬¸ë²• ì˜¤ë¥˜ ìˆ˜ì •)
      - name: Docker Login
        run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      # ğŸ—ï¸ ì´ë¯¸ì§€ ë¹Œë“œ + latest íƒœê·¸ ëª…ì‹œ
      - name: Build Images
        run: |
          docker build -t vawing21/node:latest ./server
          docker build -t vawing21/nginx:latest ./client

      # ğŸ“¤ Docker Hub í‘¸ì‹œ
      - name: Push Images
        run: |
          docker push vawing21/node:latest
          docker push vawing21/nginx:latest

      # ğŸš€ ì„œë²„ ë°°í¬
      - name: SSH Deploy
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.AWS_SERVER_HOST }}
          username: ${{ secrets.AWS_SERVER_USER }}
          key: |
            $(echo "${{ secrets.AWS_SSH_KEY }}" | base64 -d)
          port: 22
          script: |
            docker pull vawing21/node:latest
            docker pull vawing21/nginx:latest
            docker compose down
            docker compose up -d --pull always
