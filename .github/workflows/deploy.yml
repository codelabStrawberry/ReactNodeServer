name: Deploy (DEBUG)

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ğŸ” 1. Secrets ê¸¸ì´ í™•ì¸
      - name: Debug SSH Key Length
        run: |
          echo "===== SSH KEY LENGTH ====="
          echo "${{ secrets.AWS_SSH_KEY }}" | wc -c

      # ğŸ”‘ 2. SSH í‚¤ íŒŒì¼ ìƒì„±
      - name: Prepare SSH key
        run: |
          echo "===== RAW KEY PREVIEW (FIRST 3 LINES) ====="
          echo "${{ secrets.AWS_SSH_KEY }}" | head -n 3

          echo "===== RAW KEY PREVIEW (LAST 3 LINES) ====="
          echo "${{ secrets.AWS_SSH_KEY }}" | tail -n 3

          echo "${{ secrets.AWS_SSH_KEY }}" > key.pem
          sed -i 's/\r$//' key.pem
          chmod 600 key.pem

          echo "===== FILE INFO ====="
          ls -l key.pem
          file key.pem

      # ğŸ” 3. í‚¤ íŒŒì‹± í…ŒìŠ¤íŠ¸
      - name: Test SSH key parse
        run: |
          echo "===== SSH-KEYGEN TEST ====="
          ssh-keygen -l -f key.pem || true
          ssh-keygen -y -f key.pem > derived.pub || true

          echo "===== DERIVED PUBLIC KEY ====="
          cat derived.pub || true

      # ğŸ” 4. ì‹¤ì œ SSH ì ‘ì† í…ŒìŠ¤íŠ¸ (ëª…ë ¹ 1ì¤„ë§Œ)
      - name: SSH Test Only
        run: |
          ssh -vvv -o StrictHostKeyChecking=no \
              -i key.pem \
              ${{ secrets.AWS_SERVER_USER }}@${{ secrets.AWS_SERVER_HOST }} \
              "whoami"
