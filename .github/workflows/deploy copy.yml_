name: Deploy (DEBUG)

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ğŸ” 1. Secrets ê¸¸ì´ & í•´ì‹œ í™•ì¸
      - name: Debug SSH Key Length
        run: |
          echo "===== SSH KEY LENGTH ====="
          echo "${{ secrets.AWS_SSH_KEY }}" | wc -c

          echo "===== SSH KEY SHA256 (for integrity check) ====="
          echo "${{ secrets.AWS_SSH_KEY }}" | sha256sum

      # ğŸ”‘ 2. SSH í‚¤ íŒŒì¼ ìƒì„± + í¬ë§· ì •ë¦¬
      - name: Prepare SSH key
        run: |
          echo "===== RAW KEY PREVIEW (FIRST 3 LINES) ====="
          echo "${{ secrets.AWS_SSH_KEY }}" | head -n 3

          echo "===== RAW KEY PREVIEW (LAST 3 LINES) ====="
          echo "${{ secrets.AWS_SSH_KEY }}" | tail -n 3

          # íŒŒì¼ë¡œ ì €ì¥
          printf "%s\n" "${{ secrets.AWS_SSH_KEY }}" > key.pem

          # CRLF ì œê±°
          sed -i 's/\r$//' key.pem

          # ê¶Œí•œ ì„¤ì •
          chmod 600 key.pem

          echo "===== FILE INFO ====="
          ls -l key.pem
          file key.pem

          echo "===== KEY HEAD ====="
          head -n 5 key.pem

          echo "===== KEY TAIL ====="
          tail -n 5 key.pem

      # ğŸ” 3. í‚¤ íŒŒì‹± í…ŒìŠ¤íŠ¸ (ì—¬ê¸°ì„œ ì‹¤íŒ¨í•˜ë©´ Secrets ìì²´ê°€ ë§ê°€ì§„ ê±°)
      - name: Test SSH key parse
        run: |
          echo "===== SSH-KEYGEN TEST ====="
          ssh-keygen -l -f key.pem

          echo "===== DERIVED PUBLIC KEY ====="
          ssh-keygen -y -f key.pem > derived.pub
          cat derived.pub

      # ğŸ” 4. SSH ì‹¤ì œ ì—°ê²° í…ŒìŠ¤íŠ¸ (ê°•ì œ RSA ì•Œê³ ë¦¬ì¦˜ í¬í•¨)
      - name: SSH Test Only
        run: |
          ssh -vvv \
            -o StrictHostKeyChecking=no \
            -o PubkeyAcceptedAlgorithms=+ssh-rsa \
            -o HostKeyAlgorithms=+ssh-rsa \
            -i key.pem \
            ${{ secrets.AWS_SERVER_USER }}@${{ secrets.AWS_SERVER_HOST }} \
            "whoami && hostname && id"
